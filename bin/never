#!/usr/bin/env node

var IS_NODE = false;
var IS_SPACEPORT = true;

var path = require('path');
var fs = require('fs');

var watch = require('watch');
var v8socket = require('v8-socket');

var rootPath = process.argv[2] || '.';
var port = Number(process.argv[3] || 5858);
var host = process.argv[4] || '';

var socket = v8socket.connect(port, host);

var liveScripts = Object.create(null); // script path => script ID
var changeQueue = [ ];

watch.watchTree(rootPath, {
    ignoreDotFiles: true
}, function on_watchEvent(fileName, cur, prev) {
    if (typeof fileName === 'string') {
        var filePath = path.resolve(fileName);
        if (changeQueue.indexOf(filePath) < 0) {
            changeQueue.push(filePath);
        }
    }
});

function collectLiveScripts() {
    socket.request({ 'command': 'scripts' }, function on_response(err, data) {
        if (err) throw err;

        data.forEach(function (scriptData) {
            if (scriptData['type'] === 'script' && scriptData['scriptType'] === 2) {
                var name = scriptData['name'];
                if (typeof name === 'string') {
                    var id = scriptData['id'];

                    if (IS_SPACEPORT) {
                        name = path.basename(name);
                    }

                    liveScripts[name] = id;
                }
            }
        });
    });
}

function updateScripts() {
    while (changeQueue.length) {
        var filePath = changeQueue.pop();

        var scriptName = filePath;

        if (IS_SPACEPORT) {
            scriptName = path.basename(scriptName);
        }

        if (scriptName in liveScripts) {
            fs.readFile(filePath, 'utf8', function on_readFile(err, contents) {
                if (err) throw err;

                if (IS_NODE) {
                    contents = '(function (exports, require, module, __filename, __dirname) { ' + contents + '\n});';
                }

                socket.request({
                    'command': 'changelive',
                    'arguments': {
                        'script_id': liveScripts[scriptName],
                        'new_source': contents
                    }
                }, function on_response(err, data) {
                    if (err) throw err;

                    console.log(data);
                });
            });
        }
    }
}

setInterval(collectLiveScripts, 1000);
setInterval(updateScripts, 1000);
